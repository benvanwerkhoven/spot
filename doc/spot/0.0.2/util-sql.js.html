<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>util-sql.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="CategorialRule.html">CategorialRule</a><ul class='methods'><li data-type='method'><a href="CategorialRule.html#.match">match</a></li><li data-type='method'><a href="CategorialRule.html#.transform">transform</a></li></ul></li><li><a href="CategorialTransform.html">CategorialTransform</a></li><li><a href="Chart.html">Chart</a></li><li><a href="ContinuousTransform.html">ContinuousTransform</a><ul class='methods'><li data-type='method'><a href="ContinuousTransform.html#.transform">transform</a></li></ul></li><li><a href="Dataset.html">Dataset</a><ul class='methods'><li data-type='method'><a href="Dataset.html#.extendFacet">extendFacet</a></li><li data-type='method'><a href="Dataset.html#.extendFilters">extendFilters</a></li><li data-type='method'><a href="Dataset.html#.getAllData">getAllData</a></li><li data-type='method'><a href="Dataset.html#.pause">pause</a></li><li data-type='method'><a href="Dataset.html#.play">play</a></li><li data-type='method'><a href="Dataset.html#.scanData">scanData</a></li></ul></li><li><a href="Facet.html">Facet</a><ul class='methods'><li data-type='method'><a href="Facet.html#.sample10">sample10</a></li><li data-type='method'><a href="Facet.html#.setCategories">setCategories</a></li><li data-type='method'><a href="Facet.html#.setExceedances">setExceedances</a></li><li data-type='method'><a href="Facet.html#.setMinMax">setMinMax</a></li><li data-type='method'><a href="Facet.html#.setPercentiles">setPercentiles</a></li></ul></li><li><a href="Filter.html">Filter</a><ul class='methods'><li data-type='method'><a href="Filter.html#.getData">getData</a></li><li data-type='method'><a href="Filter.html#.initDataFilter">initDataFilter</a></li><li data-type='method'><a href="Filter.html#.initSelection">initSelection</a></li><li data-type='method'><a href="Filter.html#.releaseDataFilter">releaseDataFilter</a></li><li data-type='method'><a href="Filter.html#.updateDataFilter">updateDataFilter</a></li></ul></li><li><a href="Group.html">Group</a></li><li><a href="Selection.html">Selection</a><ul class='methods'><li data-type='method'><a href="Selection.html#.reset">reset</a></li><li data-type='method'><a href="Selection.html#.update">update</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-client_colors.html">client/colors</a><ul class='methods'><li data-type='method'><a href="module-client_colors.html#.getColor">getColor</a></li></ul></li><li><a href="module-client_misval.html">client/misval</a></li><li><a href="module-client_util-crossfilter.html">client/util-crossfilter</a><ul class='methods'><li data-type='method'><a href="module-client_util-crossfilter.html#~baseValueFn">baseValueFn</a></li><li data-type='method'><a href="module-client_util-crossfilter.html#~groupFn">groupFn</a></li><li data-type='method'><a href="module-client_util-crossfilter.html#~reduceFn">reduceFn</a></li><li data-type='method'><a href="module-client_util-crossfilter.html#~unpackArray">unpackArray</a></li><li data-type='method'><a href="module-client_util-crossfilter.html#~valueFn">valueFn</a></li></ul></li><li><a href="module-client_util-sql.html">client/util-sql</a><ul class='methods'><li data-type='method'><a href="module-client_util-sql.html#~connect">connect</a></li></ul></li><li><a href="module-client_view-factory.html">client/view-factory</a><ul class='methods'><li data-type='method'><a href="module-client_view-factory.html#.newView">newView</a></li></ul></li><li><a href="module-client_widget-factory.html">client/widget-factory</a><ul class='methods'><li data-type='method'><a href="module-client_widget-factory.html#.newModel">newModel</a></li></ul></li></ul><h3>Events</h3><ul><li><a href="Filter.html#event:newdata">newdata</a></li><li><a href="Filter.html#event:newfacets">newfacets</a></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<div id="main">
    
    <h1 class="page-title">util-sql.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Utility functions for SQL datasets
 * @module client/util-sql
 */
var socketIO = require('socket.io-client');
var squel = require('squel').useFlavour('postgres');
var misval = require('./misval');

function selectValid (facet) {
  var accessor = facet.accessor;
  var query = squel.expr();

  facet.misval.forEach(function (val) {
    if (val === null) {
      query.and(accessor + ' IS NOT NULL'); // FIXME document
    } else {
      if (facet.isCategorial) { // String valued facet
        query.and(accessor + " != '" + val + "'");
      } else if (facet.isContinuous) { // Number valued facet
        if (val &amp;&amp; val === +val) {
          query.and(accessor + ' != ' + val);
        }
      }
    }
  });
  return query;
}

function facetQuery (facet) {
  if (facet.isConstant) {
    return "'1'";
  }

  // bins := {
  //    label: &lt;string>                          text for display
  //    group: &lt;string> || [&lt;number>, &lt;number>]  domain of this grouping
  //    value: &lt;string> || &lt;number>              a value guaranteed to be in this group
  // }
  var accessor = facet.accessor;
  var bins = facet.bins();
  var query = squel.case();

  bins.forEach(function (bin, i) {
    var b = squel.expr();
    if (facet.displayContinuous) {
      if (i === bins.length - 1) {
        // Assign maximum value to the last bin
        b
          .and(accessor + '>=' + bin.group[0])
          .and(accessor + '&lt;=' + bin.group[1]);
      } else {
        // Assign lower limit of interval to the bin
        b
          .and(accessor + '>=' + bin.group[0])
          .and(accessor + '&lt;' + bin.group[1]);
      }
    } else if (facet.displayCategorial) {
      b
        .and(accessor + '=' + bin.group[0]);
    }
    query
      .when(b.toString())
      .then(bin.label);
  });

  if (facet.displayContinuous) {
    var last = bins.length - 1;
    query.when(accessor + '=' + bins[last].group[1]).then(bins[last].label);
  }

  // Return missing value in all other cases
  query.else(misval);

  return query;
}

/** Connect to the spot-server using a websocket on port 3080. */
function connect (dataset) {
  var socket = socketIO('http://localhost:3080');

  socket.on('connect', function () {
    console.log('spot-server: connected');
    dataset.isConnected = true;
  });

  socket.on('disconnect', function () {
    console.log('spot-server: disconnected, trying to reconnect');
    dataset.isConnected = false;
  });

  socket.on('sync-facets', function (data) {
    console.log('spot-server: sync-facets');
    dataset.facets.reset(data);
  });

  socket.on('sync-filters', function (data) {
    console.log('spot-server: sync-filters');
    dataset.filters.reset(data);
  });

  console.log('spot-server: connecting');
  socket.connect();

  dataset.socket = socket;
}

module.exports = {
  connect: connect,
  selectValid: selectValid,
  facetQuery: facetQuery
};
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Tue Jul 26 2016 16:22:41 GMT+0200 (CEST) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
